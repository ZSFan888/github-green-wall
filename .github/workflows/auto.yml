name: Auto Green Wall

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'pixel | today | range | random'
        required: true
        default: 'pixel'
        type: choice
        options:
          - pixel
          - today
          - range
          - random
      base_sunday:
        description: 'Pixel mode: base Sunday (YYYY-MM-DD)'
        required: false
        default: ''
        type: string
      grid_json:
        description: 'Pixel mode: 52x7 JSON array'
        required: false
        default: ''
        type: string
      intensity_cap:
        description: 'Max commits per day (1-10)'
        required: false
        default: '4'
        type: string
      start:
        description: 'Range/Random start date (YYYY-MM-DD)'
        required: false
        default: ''
        type: string
      end:
        description: 'Range/Random end date (YYYY-MM-DD)'
        required: false
        default: ''
        type: string
      random_max:
        description: 'Random mode max commits per day (0-10)'
        required: false
        default: '4'
        type: string
      skip_weekends:
        description: 'true/false'
        required: false
        default: 'false'
        type: string

permissions:
  contents: write

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Generate commits
        env:
          MODE: ${{ inputs.mode }}
          BASE_SUNDAY: ${{ inputs.base_sunday }}
          GRID_JSON: ${{ inputs.grid_json }}
          INTENSITY_CAP: ${{ inputs.intensity_cap }}
          START: ${{ inputs.start }}
          END: ${{ inputs.end }}
          RANDOM_MAX: ${{ inputs.random_max }}
          SKIP_WEEKENDS: ${{ inputs.skip_weekends }}
        run: |
          python3 - << 'PY'
          import os, json, random, subprocess
          from datetime import datetime, timedelta

          mode         = os.getenv('MODE', 'pixel')
          base_sunday  = os.getenv('BASE_SUNDAY', '')
          grid_json    = os.getenv('GRID_JSON', '')
          intensity_cap= int(os.getenv('INTENSITY_CAP', '4') or '4')
          start        = os.getenv('START', '')
          end          = os.getenv('END', '')
          random_max   = int(os.getenv('RANDOM_MAX', '4') or '4')
          skip_weekends= os.getenv('SKIP_WEEKENDS', 'false').lower() == 'true'

          def run(cmd, env=None):
            e = {**os.environ, **(env or {})}
            r = subprocess.run(cmd, shell=True, env=e)
            if r.returncode != 0:
              raise SystemExit(r.returncode)

          def commit_at(dt, msg):
            with open('contributions.txt', 'a', encoding='utf-8') as f:
              f.write(f"{dt.isoformat()} | {msg}\n")
            ds = dt.strftime('%Y-%m-%d %H:%M:%S')
            run('git add contributions.txt', {
              'GIT_AUTHOR_DATE':    ds,
              'GIT_COMMITTER_DATE': ds
            })
            run(f'git commit -m "{msg}"', {
              'GIT_AUTHOR_DATE':    ds,
              'GIT_COMMITTER_DATE': ds
            })

          def daterange(a, b):
            d = a
            while d <= b:
              yield d
              d += timedelta(days=1)

          # ── today ──────────────────────────────────────────
          if mode == 'today':
            d = datetime.now().replace(hour=10, minute=0, second=0, microsecond=0)
            for i in range(max(1, intensity_cap)):
              commit_at(d + timedelta(minutes=i), f"today: {d.date()} #{i+1}")

          # ── range ───────────────────────────────────────────
          elif mode == 'range':
            if not start or not end:
              raise SystemExit('start/end required')
            a = datetime.strptime(start, '%Y-%m-%d')
            b = datetime.strptime(end,   '%Y-%m-%d')
            for day in daterange(a, b):
              if skip_weekends and day.weekday() >= 5:
                continue
              for i in range(intensity_cap):
                dt = day.replace(hour=9 + (i % 8), minute=(i * 7) % 60, second=0)
                commit_at(dt, f"range: {day.date()} #{i+1}")

          # ── random ──────────────────────────────────────────
          elif mode == 'random':
            if not start or not end:
              raise SystemExit('start/end required')
            a = datetime.strptime(start, '%Y-%m-%d')
            b = datetime.strptime(end,   '%Y-%m-%d')
            for day in daterange(a, b):
              if skip_weekends and day.weekday() >= 5:
                continue
              n = random.randint(0, max(0, random_max))
              for i in range(n):
                dt = day.replace(hour=9 + (i % 8), minute=(i * 7) % 60, second=0)
                commit_at(dt, f"random: {day.date()} #{i+1}")

          # ── pixel ───────────────────────────────────────────
          elif mode == 'pixel':
            if not base_sunday:
              raise SystemExit('base_sunday required')
            if not grid_json:
              raise SystemExit('grid_json required')
            base = datetime.strptime(base_sunday, '%Y-%m-%d')
            grid = json.loads(grid_json)   # shape: [52][7]
            total = 0
            for x in range(len(grid)):
              col = grid[x]
              for y in range(min(7, len(col))):
                level = int(col[y])
                n = min(intensity_cap, max(0, level))
                if n == 0:
                  continue
                day = base + timedelta(days=x * 7 + y)
                for i in range(n):
                  dt = day.replace(hour=9 + (i % 8), minute=(i * 11) % 60, second=0)
                  commit_at(dt, f"pixel: {day.date()} x{x}y{y} lvl{level} #{i+1}")
                  total += 1
            print(f"pixel mode: {total} commits generated")

          else:
            raise SystemExit(f'unknown mode: {mode}')

          print(f"done: mode={mode}")
          PY

      - name: Push
        run: git push origin main
